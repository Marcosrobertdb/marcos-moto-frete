<script>
document.addEventListener("DOMContentLoaded", () => {

    const btnCalcular = document.getElementById("btnCalcular");
    const btnWhats = document.getElementById("btnWhats");
    let precoGlobal = 0;

    async function getCoords(endereco) {
        const url = "https://geocode.maps.co/search?q=" + encodeURIComponent(endereco);

        const resposta = await fetch(url);
        const dados = await resposta.json();

        if (!dados || dados.length === 0) return null;

        return {
            lat: parseFloat(dados[0].lat),
            lon: parseFloat(dados[0].lon)
        };
    }

    function distanciaKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;

        const a =
            Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI / 180) *
            Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) ** 2;

        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    btnCalcular.addEventListener("click", async () => {
        const origem = document.getElementById("origem").value;
        const destino = document.getElementById("destino").value;

        const c1 = await getCoords(origem);
        const c2 = await getCoords(destino);

        if (!c1 || !c2) {
            document.getElementById("resultado").innerText = "Endereço não encontrado.";
            return;
        }

        const km = distanciaKm(c1.lat, c1.lon, c2.lat, c2.lon);
        precoGlobal = km * 2;

        document.getElementById("resultado").innerText =
            "Distância: " + km.toFixed(2) + " km — Preço: R$ " + precoGlobal.toFixed(2);

        btnWhats.style.display = "block";
    });

    btnWhats.addEventListener("click", () => {
        const origem = document.getElementById("origem").value;
        const destino = document.getElementById("destino").value;

        const msg =
            "*Pedido de Frete*" +
            "%0AOrigem: " + origem +
            "%0ADestino: " + destino +
            "%0APreço: R$ " + precoGlobal.toFixed(2);

        window.open("https://wa.me/5511965283733?text=" + msg);
    });

});
</script>
